# 供应商缺货处理流程

## 一、供应商标记缺货

### 1.1 标记缺货操作
- **操作位置**：供应商在"我的报价"页面，中标记录中点击"标记缺货"按钮
- **需要填写**：缺货原因（必填）
- **支持范围**：
  - 可以标记单个商品缺货
  - 可以标记整个中标缺货

### 1.2 标记缺货后的系统行为

#### 数据库更新
1. **商品状态更新**：
   - `RfqItem.itemStatus` → `OUT_OF_STOCK`
   - `RfqItem.exceptionReason` → 缺货原因
   - `RfqItem.exceptionAt` → 标记时间

2. **中标状态更新**：
   - 如果所有商品都缺货，`Award.status` → `OUT_OF_STOCK`
   - 如果只是部分商品缺货，`Award.status` 保持 `ACTIVE`

#### 通知机制
- 系统自动发送通知给**采购员/管理员**
- 通知内容包含：
  - 供应商名称
  - 询价单编号
  - 缺货原因
  - 处理建议（重新发询价单或转为电商采购）

#### 审计日志
- 记录操作日志：`MARK_OUT_OF_STOCK`
- 包含操作人、时间、原因等详细信息

---

## 二、采购员/管理员的处理方式

采购员/管理员在收到缺货通知后，可以在"发货管理"页面看到缺货的中标记录，并有以下三种处理方式：

### 2.1 方式一：重新创建询价单 ⭐ 推荐

#### 操作步骤
1. 在发货管理页面，找到状态为"缺货"的中标记录
2. 点击"重新创建询价单"按钮
3. 系统自动创建新的询价单

#### 系统行为
- **创建新询价单**：
  - 询价单编号：`RFQ-{时间戳}`
  - 标题：`重新询价-{原询价单标题}`
  - 描述：`基于询价单 {原询价单编号} 重新询价（供应商 {供应商名} 缺货）`
  - 状态：`PUBLISHED`（已发布）
  - 截止时间：默认7天后（可自定义）

- **复制缺货商品**：
  - 只包含状态为 `OUT_OF_STOCK` 的商品
  - 保留商品信息（名称、数量、单位、描述等）
  - 商品状态重置为 `PENDING`

- **通知供应商**：
  - 发送通知给原供应商，提醒其可以重新报价

#### 适用场景
- 希望重新询价，寻找其他供应商
- 商品不紧急，可以等待新的报价周期
- 希望获得更优价格

---

### 2.2 方式二：转为电商平台采购

#### 操作步骤
1. 在发货管理页面，找到状态为"缺货"的中标记录
2. 点击"转为电商采购"按钮
3. 确认转换操作

#### 系统行为
- **商品状态更新**：
  - `RfqItem.itemStatus` → `ECOMMERCE_PENDING`（电商采购待付款）
  - `RfqItem.source` → `ECOMMERCE`
  - `RfqItem.exceptionReason` → `已转为电商平台采购（原供应商缺货）`

- **后续操作**：
  - 商品会出现在"电商采购订单"页面
  - 采购员需要手动补充：
    - 物流单号（trackingNo）
    - 快递公司（carrier）
    - 成交价格（costPrice）

#### 适用场景
- 商品紧急，需要快速采购
- 电商平台有现货，价格可接受
- 不需要重新询价流程

---

### 2.3 方式三：取消中标

#### 操作步骤
1. 在发货管理页面，找到状态为"缺货"的中标记录
2. 点击"取消中标"按钮
3. 选择取消原因和操作类型：
   - `CANCEL`：直接取消
   - `SWITCH_TO_ECOMMERCE`：取消并转为电商采购（等同于方式二）
   - `REASSIGN`：取消并重新创建询价单（等同于方式一）

#### 系统行为
- **中标状态更新**：
  - `Award.status` → `CANCELLED`
  - 记录取消原因和操作人

- **商品状态更新**：
  - 根据选择的操作类型，执行相应处理

- **通知供应商**：
  - 发送取消通知给供应商

#### 适用场景
- 需要明确取消中标关系
- 需要记录取消原因用于后续分析

---

## 三、处理流程对比

| 处理方式 | 操作位置 | 创建新询价单 | 转为电商采购 | 取消中标 | 适用场景 |
|---------|---------|------------|------------|---------|---------|
| **重新创建询价单** | 发货管理页面 | ✅ 是 | ❌ 否 | ❌ 否 | 不紧急，重新询价 |
| **转为电商采购** | 发货管理页面 | ❌ 否 | ✅ 是 | ❌ 否 | 紧急，电商有货 |
| **取消中标** | 发货管理页面 | 可选 | 可选 | ✅ 是 | 需要明确取消关系 |

---

## 四、状态流转图

```
供应商中标 (AWARDED)
    ↓
供应商标记缺货
    ↓
商品状态: OUT_OF_STOCK
中标状态: OUT_OF_STOCK (如果所有商品都缺货)
    ↓
    ├─→ 重新创建询价单
    │   └─→ 新询价单 (PUBLISHED)
    │       └─→ 商品状态: PENDING
    │
    ├─→ 转为电商采购
    │   └─→ 商品状态: ECOMMERCE_PENDING
    │       └─→ 商品来源: ECOMMERCE
    │
    └─→ 取消中标
        └─→ 中标状态: CANCELLED
```

---

## 五、注意事项

### 5.1 部分缺货 vs 全部缺货
- **部分缺货**：只有部分商品标记为缺货
  - 其他商品仍可正常发货
  - 中标状态保持 `ACTIVE`
  - 可以针对缺货商品单独处理

- **全部缺货**：所有商品都标记为缺货
  - 中标状态变为 `OUT_OF_STOCK`
  - 需要整体处理

### 5.2 已发货商品
- 已发货的商品（`itemStatus === 'SHIPPED'`）不会被标记为缺货
- 标记整个中标缺货时，已发货的商品状态不会改变

### 5.3 虚拟 Award 支持
- 系统支持虚拟 Award（按商品级别选商）的缺货标记
- 标记缺货时会自动创建真实的 Award 记录

---

## 六、API 接口

### 6.1 标记缺货
```
POST /api/awards/:awardId/out-of-stock
Body: {
  reason: string,        // 缺货原因（必填）
  rfqItemId?: string     // 商品ID（可选，不填则标记整个中标）
}
```

### 6.2 重新创建询价单
```
POST /api/awards/:awardId/recreate-rfq
Body: {
  deadline?: string      // 截止时间（可选，ISO 8601格式）
}
```

### 6.3 转为电商采购
```
POST /api/awards/:awardId/convert-to-ecommerce
Body: {
  rfqItemIds?: string[]  // 商品ID列表（可选，不填则转换所有缺货商品）
}
```

### 6.4 取消中标
```
POST /api/awards/:awardId/cancel
Body: {
  reason: string,        // 取消原因（必填）
  action: 'CANCEL' | 'SWITCH_TO_ECOMMERCE' | 'REASSIGN'
}
```

---

## 七、前端页面位置

### 7.1 供应商端
- **页面**：`/quotes`（我的报价）
- **操作**：在中标记录中点击"标记缺货"按钮

### 7.2 采购员/管理员端
- **页面**：`/shipments`（发货管理）
- **操作**：
  - 查看缺货的中标记录（状态显示为"缺货"）
  - 点击"重新创建询价单"、"转为电商采购"或"取消中标"按钮

---

## 八、最佳实践建议

1. **及时处理**：收到缺货通知后，尽快选择处理方式
2. **根据紧急程度选择**：
   - 紧急商品 → 转为电商采购
   - 不紧急商品 → 重新创建询价单
3. **记录原因**：标记缺货时填写详细原因，便于后续分析
4. **沟通协调**：必要时与供应商沟通，了解缺货原因和预计恢复时间

