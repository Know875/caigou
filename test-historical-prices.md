# 历史价格记忆功能测试指南

## 功能说明
在询价单详情页，当用户设置商品的最高限价时，系统会自动查询最近5天内相同商品的历史价格，并显示提示卡片，方便用户一键应用历史价格。

## 测试步骤

### 前置准备

1. **启动应用**
   ```bash
   # 启动后端（如果还没启动）
   cd apps/api
   npm run start:dev

   # 启动前端（如果还没启动）
   cd apps/web
   npm run dev
   ```

2. **准备测试数据**
   - 确保数据库中有至少一个询价单，且该询价单已设置最高限价（不是草稿状态）
   - 该询价单的商品名称需要记住，用于后续测试

### 测试场景 1：基本功能测试

**目标**：验证历史价格查询和显示功能

**步骤**：
1. 登录系统（使用管理员、采购员或门店账号）
2. 进入询价单列表页（`/rfqs`）
3. 创建一个新的询价单（或使用已有的草稿询价单）
4. 添加一个商品，商品名称使用之前已有历史记录的询价单中的商品名称
5. 保存询价单（状态变为草稿）
6. 进入询价单详情页（`/rfqs/[id]`）
7. 找到刚才添加的商品，点击"设置最高限价"按钮
8. **预期结果**：
   - 输入框下方应该显示"查询历史价格中..."的加载提示
   - 几秒后，如果找到历史记录，应该显示蓝色背景的历史价格卡片
   - 卡片中显示：
     - 历史询价单的标题/编号
     - 创建时间
     - 最高限价和一口价（如果有）
     - "应用"按钮

### 测试场景 2：一键应用历史价格

**目标**：验证点击"应用"按钮可以填充历史价格

**步骤**：
1. 在测试场景1的基础上，点击历史价格卡片中的"应用"按钮
2. **预期结果**：
   - 最高限价输入框自动填充历史记录中的最高限价
   - 如果历史记录有一口价，一口价输入框也会自动填充
   - 可以继续编辑或直接保存

### 测试场景 3：无历史记录的情况

**目标**：验证当没有历史记录时，不显示提示卡片

**步骤**：
1. 创建一个询价单，添加一个全新的商品（商品名称在最近5天内没有出现过）
2. 进入询价单详情页，点击"设置最高限价"
3. **预期结果**：
   - 显示"查询历史价格中..."的加载提示
   - 几秒后，如果没有找到历史记录，不显示任何提示卡片
   - 可以正常输入价格

### 测试场景 4：门店过滤功能

**目标**：验证门店用户只能看到自己门店的历史记录

**步骤**：
1. 使用门店账号登录
2. 创建一个询价单，添加商品
3. 点击"设置最高限价"
4. **预期结果**：
   - 只显示该门店最近5天内的历史价格
   - 不显示其他门店的历史记录

### 测试场景 5：多条历史记录

**目标**：验证当有多条历史记录时的显示

**步骤**：
1. 确保有至少3条相同商品的历史记录（在最近5天内）
2. 创建新询价单，添加相同商品
3. 点击"设置最高限价"
4. **预期结果**：
   - 最多显示3条历史记录
   - 如果超过3条，显示"还有 X 条历史记录..."的提示
   - 每条记录都可以单独点击"应用"

### 测试场景 6：时间范围验证

**目标**：验证只显示最近5天内的记录

**步骤**：
1. 查看数据库，确认有超过5天的历史询价单记录
2. 创建新询价单，添加相同商品
3. 点击"设置最高限价"
4. **预期结果**：
   - 只显示最近5天内的历史记录
   - 超过5天的记录不显示

### 测试场景 7：从文件导入的询价单

**目标**：验证从文件导入创建的询价单也能使用历史价格功能

**步骤**：
1. 通过文件导入创建一个询价单
2. 进入询价单详情页（会自动打开第一个未设置最高限价的商品）
3. **预期结果**：
   - 自动查询该商品的历史价格
   - 显示历史价格提示卡片（如果有）

## 后端API测试

### 直接测试接口

可以使用 Postman 或 curl 直接测试后端接口：

```bash
# 测试历史价格查询接口
curl -X GET "http://localhost:3000/api/rfqs/historical-prices?productName=测试商品名称" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# 带门店ID的查询
curl -X GET "http://localhost:3000/api/rfqs/historical-prices?productName=测试商品名称&storeId=门店ID" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

**预期响应**：
```json
[
  {
    "maxPrice": 200.00,
    "instantPrice": 180.00,
    "rfqNo": "RFQ-20250101-001",
    "rfqTitle": "测试询价单",
    "createdAt": "2025-01-20T10:00:00.000Z",
    "storeName": "测试门店"
  }
]
```

## 常见问题排查

### 1. 没有显示历史价格提示
- 检查商品名称是否完全匹配（目前使用 `contains` 模糊匹配）
- 检查历史询价单是否在最近5天内
- 检查历史询价单的状态是否为草稿（草稿状态会被排除）
- 检查历史询价单的商品是否设置了最高限价

### 2. 门店用户看到了其他门店的记录
- 检查后端是否正确获取了用户的门店ID
- 检查查询条件是否正确应用了门店过滤

### 3. 接口返回错误
- 检查 JWT token 是否有效
- 检查商品名称参数是否正确传递
- 查看后端日志，确认是否有错误信息

## 数据库查询验证

可以直接查询数据库验证数据：

```sql
-- 查看最近5天内的询价单商品（已设置最高限价）
SELECT 
  ri.id,
  ri.productName,
  ri.maxPrice,
  ri.instantPrice,
  ri.createdAt,
  r.rfqNo,
  r.title,
  r.status,
  s.name as storeName
FROM rfq_items ri
JOIN rfqs r ON ri.rfqId = r.id
LEFT JOIN stores s ON r.storeId = s.id
WHERE 
  ri.productName LIKE '%商品名称%'
  AND ri.createdAt >= DATE_SUB(NOW(), INTERVAL 5 DAY)
  AND ri.maxPrice IS NOT NULL
  AND r.status != 'DRAFT'
ORDER BY ri.createdAt DESC
LIMIT 10;
```

## 测试检查清单

- [ ] 基本功能：能查询并显示历史价格
- [ ] 一键应用：点击"应用"按钮能填充价格
- [ ] 无历史记录：没有历史记录时不显示提示
- [ ] 门店过滤：门店用户只看到自己门店的记录
- [ ] 多条记录：能正确显示多条历史记录
- [ ] 时间范围：只显示最近5天内的记录
- [ ] 加载状态：查询时显示加载提示
- [ ] 错误处理：网络错误时不影响正常输入

