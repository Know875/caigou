#!/bin/bash

echo "=========================================="
echo "å½»åº•æ¸…ç†æ¶æ„è½¯ä»¶"
echo "=========================================="
echo ""

# 1. ç»ˆæ­¢æ‰€æœ‰å¯ç–‘è¿›ç¨‹
echo "ðŸ“Š 1. ç»ˆæ­¢æ‰€æœ‰å¯ç–‘è¿›ç¨‹"
echo "----------------------------------------"

# ç»ˆæ­¢ runnv ç›¸å…³è¿›ç¨‹
pkill -9 -f "/tmp/runnv" 2>/dev/null || true
pkill -9 -f "runnv" 2>/dev/null || true
pkill -9 -f "alive.sh" 2>/dev/null || true
pkill -9 -f "lived.sh" 2>/dev/null || true
pkill -9 -f "monitor_tomcat" 2>/dev/null || true

# ç»ˆæ­¢æ‰€æœ‰ Node.js è¿›ç¨‹
pkill -9 node 2>/dev/null || true
pkill -9 pm2 2>/dev/null || true

sleep 3

# å¼ºåˆ¶ç»ˆæ­¢
ps aux | grep -E "runnv|alive.sh|lived.sh|monitor_tomcat" | grep -v grep | awk '{print $2}' | xargs kill -9 2>/dev/null || true
sleep 2

echo "âœ“ å¯ç–‘è¿›ç¨‹å·²ç»ˆæ­¢"

# 2. ç¦ç”¨æ¶æ„æœåŠ¡
echo ""
echo "ðŸ“Š 2. ç¦ç”¨æ¶æ„æœåŠ¡"
echo "----------------------------------------"
systemctl stop nginxd.service 2>/dev/null || true
systemctl disable nginxd.service 2>/dev/null || true
systemctl stop monitor_tomcat.service 2>/dev/null || true
systemctl disable monitor_tomcat.service 2>/dev/null || true
echo "âœ“ æ¶æ„æœåŠ¡å·²ç¦ç”¨"

# 3. åˆ é™¤æ¶æ„æ–‡ä»¶å’Œç›®å½•
echo ""
echo "ðŸ“Š 3. åˆ é™¤æ¶æ„æ–‡ä»¶å’Œç›®å½•"
echo "----------------------------------------"
rm -rf /tmp/runnv 2>/dev/null || true
rm -f /tmp/fghgf 2>/dev/null || true
rm -f /tmp/config.json 2>/dev/null || true
rm -f /dev/health.sh 2>/dev/null || true

# é”å®šæ–‡ä»¶ï¼ˆé˜²æ­¢é‡æ–°åˆ›å»ºï¼‰
touch /tmp/fghgf /tmp/config.json /dev/health.sh 2>/dev/null || true
chmod 000 /tmp/fghgf /tmp/config.json /dev/health.sh 2>/dev/null || true
chattr +i /tmp/fghgf /tmp/config.json /dev/health.sh 2>/dev/null || true

echo "âœ“ æ¶æ„æ–‡ä»¶å·²åˆ é™¤å¹¶é”å®š"

# 4. æ¸…ç†å®šæ—¶ä»»åŠ¡
echo ""
echo "ðŸ“Š 4. æ¸…ç†å®šæ—¶ä»»åŠ¡"
echo "----------------------------------------"
crontab -l 2>/dev/null | grep -v "runnv\|alive.sh\|lived.sh\|fghgf\|unk.sh\|corn" | crontab - 2>/dev/null || true
rm -f /etc/cron.d/rondo 2>/dev/null || true
sed -i '/runnv\|alive.sh\|lived.sh\|fghgf/d' /etc/crontab 2>/dev/null || true
echo "âœ“ å®šæ—¶ä»»åŠ¡å·²æ¸…ç†"

# 5. æ¸…ç† systemd æœåŠ¡
echo ""
echo "ðŸ“Š 5. æ¸…ç† systemd æœåŠ¡"
echo "----------------------------------------"
rm -f /etc/systemd/system/nginxd.service 2>/dev/null || true
rm -f /etc/systemd/system/monitor_tomcat.service 2>/dev/null || true
systemctl daemon-reload 2>/dev/null || true
echo "âœ“ systemd æœåŠ¡å·²æ¸…ç†"

# 6. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
echo ""
echo "ðŸ“Š 6. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€"
echo "----------------------------------------"
uptime
free -h

# 7. ç­‰å¾…ç³»ç»Ÿç¨³å®š
echo ""
echo "ðŸ“Š 7. ç­‰å¾…ç³»ç»Ÿç¨³å®šï¼ˆ20ç§’ï¼‰..."
sleep 20

# 8. å¯åŠ¨æœåŠ¡
echo ""
echo "ðŸ“Š 8. å¯åŠ¨æœåŠ¡ï¼ˆæœ€å°é…ç½®ï¼‰"
echo "----------------------------------------"
cd /root/caigou/caigou

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs

# ä½¿ç”¨æœ€å°å†…å­˜é™åˆ¶å¯åŠ¨ API
echo "å¯åŠ¨ API æœåŠ¡..."
NODE_OPTIONS="--max-old-space-size=128 --optimize-for-size" \
NODE_ENV=production \
nohup node apps/api/dist/main.js > logs/api-out.log 2> logs/api-error.log &
API_PID=$!
echo "API PID: $API_PID"
sleep 10

# æ£€æŸ¥ API æ˜¯å¦å¯åŠ¨æˆåŠŸ
if ps -p $API_PID > /dev/null; then
    echo "âœ“ API æœåŠ¡å¯åŠ¨æˆåŠŸ (PID: $API_PID)"
    sleep 5
    curl -s http://localhost:8081/api/health && echo "" || echo "âš ï¸  API å°šæœªå°±ç»ª"
    
    # å¦‚æžœ API æˆåŠŸï¼Œå¯åŠ¨ Worker
    echo ""
    echo "å¯åŠ¨ Worker æœåŠ¡..."
    NODE_OPTIONS="--max-old-space-size=128 --optimize-for-size" \
    NODE_ENV=production \
    nohup node apps/api/dist/worker.js > logs/worker-out.log 2> logs/worker-error.log &
    WORKER_PID=$!
    echo "Worker PID: $WORKER_PID"
    sleep 10
    
    if ps -p $WORKER_PID > /dev/null; then
        echo "âœ“ Worker æœåŠ¡å¯åŠ¨æˆåŠŸ (PID: $WORKER_PID)"
    else
        echo "âœ— Worker æœåŠ¡å¯åŠ¨å¤±è´¥"
    fi
else
    echo "âœ— API æœåŠ¡å¯åŠ¨å¤±è´¥"
    tail -n 30 logs/api-error.log
fi

# 9. ä¿å­˜è¿›ç¨‹ä¿¡æ¯
echo ""
echo "ðŸ“Š 9. ä¿å­˜è¿›ç¨‹ä¿¡æ¯"
echo "----------------------------------------"
cat > /root/caigou/caigou/.service-pids << EOF
API_PID=$API_PID
WORKER_PID=$WORKER_PID
EOF
echo "âœ“ è¿›ç¨‹ä¿¡æ¯å·²ä¿å­˜"

# 10. æ˜¾ç¤ºè¿è¡ŒçŠ¶æ€
echo ""
echo "ðŸ“Š 10. æœåŠ¡è¿è¡ŒçŠ¶æ€"
echo "----------------------------------------"
ps aux | grep -E "node.*main.js|node.*worker.js" | grep -v grep

echo ""
echo "=========================================="
echo "æ¸…ç†å’Œå¯åŠ¨å®Œæˆ"
echo "=========================================="

