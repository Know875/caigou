#!/bin/bash

echo "=========================================="
echo "彻底阻止恶意软件恢复"
echo "=========================================="
echo ""

# 1. 检查并终止所有恶意进程
echo "📊 1. 终止所有恶意进程"
echo "----------------------------------------"
pkill -9 -f "fghgf" 2>/dev/null && echo "✓ 已终止 fghgf 进程" || echo "无 fghgf 进程"
pkill -9 -f "health.sh" 2>/dev/null && echo "✓ 已终止 health.sh 进程" || echo "无 health.sh 进程"
pkill -9 -f "89.144.31.18" 2>/dev/null && echo "✓ 已终止恶意下载进程" || echo "无恶意下载进程"
pkill -9 -f "wget.*89.144.31.18" 2>/dev/null && echo "✓ 已终止恶意 wget 进程" || echo "无恶意 wget 进程"

# 2. 检查所有定时任务
echo ""
echo "📊 2. 检查所有定时任务"
echo "----------------------------------------"
echo "Root crontab:"
crontab -l 2>/dev/null | grep -v "^#" | grep -v "^$" || echo "无定时任务"

echo ""
echo "系统 crontab:"
cat /etc/crontab 2>/dev/null | grep -v "^#" | grep -v "^$" || echo "无定时任务"

echo ""
echo "Cron 目录文件:"
ls -la /etc/cron.d/ 2>/dev/null
ls -la /etc/cron.hourly/ 2>/dev/null
ls -la /etc/cron.daily/ 2>/dev/null
ls -la /etc/cron.weekly/ 2>/dev/null
ls -la /etc/cron.monthly/ 2>/dev/null

# 3. 清理所有恶意定时任务
echo ""
echo "📊 3. 清理所有恶意定时任务"
echo "----------------------------------------"
# 清理 root crontab
crontab -l 2>/dev/null | grep -v "89.144.31.18" | grep -v "80.64.16.241" | grep -v "205.185.126.196" | grep -v "rondo" | grep -v "unk.sh" | grep -v "corn" | grep -v "whale-corps-dev" | grep -v "pub-dc84e32afcfa417fa04d36454032549b" | crontab - 2>/dev/null
echo "✓ 已清理 root crontab"

# 清理系统 crontab
sed -i '/89.144.31.18/d' /etc/crontab 2>/dev/null
sed -i '/80.64.16.241/d' /etc/crontab 2>/dev/null
sed -i '/205.185.126.196/d' /etc/crontab 2>/dev/null
sed -i '/rondo/d' /etc/crontab 2>/dev/null
echo "✓ 已清理系统 crontab"

# 删除所有可疑的 cron 文件
rm -f /etc/cron.d/*rondo* 2>/dev/null
rm -f /etc/cron.d/*malware* 2>/dev/null
rm -f /etc/cron.hourly/*malware* 2>/dev/null
rm -f /etc/cron.daily/*malware* 2>/dev/null
rm -f /etc/cron.weekly/*malware* 2>/dev/null
rm -f /etc/cron.monthly/*malware* 2>/dev/null
echo "✓ 已删除可疑 cron 文件"

# 4. 阻止恶意 IP
echo ""
echo "📊 4. 阻止恶意 IP"
echo "----------------------------------------"
# 安装 ufw（如果未安装）
if ! command -v ufw &> /dev/null; then
    apt update -qq > /dev/null 2>&1
    apt install -y ufw > /dev/null 2>&1
fi

# 阻止恶意 IP
if command -v ufw &> /dev/null; then
    ufw --force enable > /dev/null 2>&1
    ufw deny from 89.144.31.18 2>/dev/null && echo "✓ 已阻止 89.144.31.18" || echo "规则可能已存在"
    ufw deny from 80.64.16.241 2>/dev/null && echo "✓ 已阻止 80.64.16.241" || echo "规则可能已存在"
    ufw deny from 205.185.126.196 2>/dev/null && echo "✓ 已阻止 205.185.126.196" || echo "规则可能已存在"
    ufw deny out to 89.144.31.18 2>/dev/null && echo "✓ 已阻止出站到 89.144.31.18" || echo "规则可能已存在"
    ufw deny out to 80.64.16.241 2>/dev/null && echo "✓ 已阻止出站到 80.64.16.241" || echo "规则可能已存在"
    ufw deny out to 205.185.126.196 2>/dev/null && echo "✓ 已阻止出站到 205.185.126.196" || echo "规则可能已存在"
    echo "✓ 防火墙规则已配置"
fi

# 5. 检查并删除启动脚本
echo ""
echo "📊 5. 检查并删除启动脚本"
echo "----------------------------------------"
rm -f /etc/init.d/rondo 2>/dev/null && echo "✓ 已删除 /etc/init.d/rondo" || echo "文件可能已不存在"
rm -f /etc/rc*.d/*rondo* 2>/dev/null && echo "✓ 已删除启动链接" || echo "链接可能已不存在"
rm -rf /etc/rondo 2>/dev/null && echo "✓ 已删除 /etc/rondo 目录" || echo "目录可能已不存在"

# 6. 禁用 systemd 服务
echo ""
echo "📊 6. 禁用 systemd 服务"
echo "----------------------------------------"
systemctl stop rondo.service 2>/dev/null && echo "✓ 已停止 rondo 服务" || echo "服务可能已停止"
systemctl disable rondo.service 2>/dev/null && echo "✓ 已禁用 rondo 服务" || echo "服务可能已禁用"
rm -f /etc/systemd/system/rondo.service 2>/dev/null && echo "✓ 已删除服务文件" || echo "服务文件可能已不存在"
systemctl daemon-reload 2>/dev/null && echo "✓ 已重新加载 systemd" || echo "无法重新加载 systemd"

# 7. 检查恶意网络连接
echo ""
echo "📊 7. 检查恶意网络连接"
echo "----------------------------------------"
ss -tunp | grep -E "89.144.31.18|80.64.16.241|205.185.126.196" || echo "✓ 无恶意网络连接"

# 8. 检查剩余恶意进程
echo ""
echo "📊 8. 检查剩余恶意进程"
echo "----------------------------------------"
ps aux | grep -E "fghgf|health.sh|rondo|89.144.31.18|80.64.16.241|205.185.126.196" | grep -v grep || echo "✓ 无恶意进程"

# 9. 检查系统负载
echo ""
echo "📊 9. 检查系统负载"
echo "----------------------------------------"
top -b -n 1 | head -n 5

echo ""
echo "=========================================="
echo "清理完成"
echo "=========================================="
echo ""
echo "⚠️  重要提示："
echo "1. 恶意软件仍在尝试恢复，但文件已被锁定，无法创建"
echo "2. 已阻止所有恶意 IP"
echo "3. 已清理所有定时任务"
echo "4. 建议定期检查系统日志：pm2 logs caigou-web --err | grep -i 'malware\|suspicious'"
echo "5. 如果发现新的恶意 IP，立即添加到防火墙规则"

