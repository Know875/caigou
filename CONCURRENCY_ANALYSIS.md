# 系统并发能力分析报告

## 📊 当前配置概览

### 1. API 服务器（NestJS）

**部署配置**：
- **实例数**: 2 个（PM2 集群模式）
- **数据库连接池**: 每个实例 20 个连接
- **总数据库连接数**: 40 个
- **内存限制**: 每个实例 1GB

**理论并发能力**：
- Node.js 单线程事件循环，可以处理大量并发 I/O 请求
- 每个 API 实例理论上可以同时处理 **数百到数千个并发请求**（取决于请求类型）
- 实际瓶颈通常在数据库连接池

**实际并发估算**：
- **轻量级请求**（简单查询）：每个实例 ~500-1000 并发
- **中等请求**（复杂查询）：每个实例 ~200-500 并发
- **重量级请求**（大量数据处理）：每个实例 ~50-200 并发
- **总体估算**：**2 个实例 ≈ 400-2000 并发请求/秒**（取决于请求类型）

---

### 2. 数据库（MySQL）

**连接池配置**：
```sql
connection_limit=20&pool_timeout=10
```

**限制因素**：
- **总连接数**: 40 个（2 个 API 实例 × 20）
- **MySQL 默认最大连接数**: 通常 151（可调整）
- **实际可用连接**: 受限于 MySQL 配置和服务器资源

**性能指标**：
- **简单查询**: 每个连接可处理 ~100-500 QPS
- **复杂查询**: 每个连接可处理 ~10-50 QPS
- **总体估算**: **40 个连接 ≈ 400-20,000 QPS**（取决于查询复杂度）

**瓶颈分析**：
- ✅ 已优化：批量查询减少 N+1 问题
- ⚠️ 潜在瓶颈：复杂报表查询、大量 JOIN 操作
- ⚠️ 建议：监控慢查询日志，优化索引

---

### 3. 队列系统（BullMQ + Redis）

**Worker 配置**：

| 队列类型 | Worker 数 | 并发数 | 总并发能力 |
|---------|----------|--------|-----------|
| Auction（评标） | 1 | 5 | 5 个任务/秒 |
| OCR（识别） | 1 | 3 | 3 个任务/秒 |
| Notification（通知） | 1 | 10 | 10 个任务/秒 |
| AfterSales（售后） | 1 | 5 | 5 个任务/秒 |
| **总计** | **1** | **23** | **~23 个任务/秒** |

**Redis 性能**：
- Redis 单线程，但性能极高
- **理论吞吐量**: 100,000+ 操作/秒
- **实际瓶颈**: 网络延迟、数据序列化

**队列容量**：
- BullMQ 队列存储在 Redis 中
- **理论容量**: 受 Redis 内存限制（通常数 GB）
- **实际建议**: 监控队列长度，避免积压

---

### 4. Web 前端（Next.js）

**部署配置**：
- **实例数**: 2 个（PM2 集群模式）
- **内存限制**: 每个实例 1GB

**并发能力**：
- Next.js 支持 SSR 和静态生成
- **静态页面**: 几乎无限制
- **SSR 页面**: 受 API 调用限制
- **总体估算**: **2 个实例 ≈ 1000-5000 并发用户**（取决于页面类型）

---

## 🎯 系统整体并发能力

### 理论最大值

**API 层**：
- 2 个实例 × 500 并发/实例 = **1,000 并发请求**

**数据库层**：
- 40 个连接 × 50 QPS/连接 = **2,000 QPS**

**队列层**：
- 23 个并发任务处理能力

**实际建议值**：
- **保守估算**: **200-500 并发用户**
- **中等负载**: **500-1000 并发用户**
- **高负载**: **1000-2000 并发用户**（需要优化）

---

## ⚠️ 性能瓶颈分析

### 1. 数据库连接池（主要瓶颈）

**当前限制**：
- 每个 API 实例只有 20 个数据库连接
- 当连接耗尽时，新请求会等待

**优化建议**：
```javascript
// 增加连接池大小
DATABASE_URL=mysql://...?connection_limit=50&pool_timeout=10
```

**影响**：
- 增加连接数可以提高并发，但会增加数据库负载
- 需要监控 MySQL 的 `max_connections` 设置

### 2. 复杂查询性能

**已优化**：
- ✅ 批量查询减少 N+1 问题
- ✅ 添加了数据库索引

**潜在问题**：
- ⚠️ 复杂报表查询可能较慢
- ⚠️ 大量数据的 JOIN 操作

**优化建议**：
- 添加查询缓存（Redis）
- 优化慢查询
- 考虑读写分离

### 3. 队列处理能力

**当前限制**：
- 评标队列：5 并发（可能成为瓶颈）
- OCR 队列：3 并发（处理较慢）

**优化建议**：
```typescript
// 增加 Worker 并发数
concurrency: 10, // 从 5 增加到 10
```

**或增加 Worker 实例**：
```javascript
// PM2 配置
{
  name: 'egg-purchase-worker',
  instances: 2, // 从 1 增加到 2
}
```

---

## 🚀 提升并发能力的方案

### 方案 1：增加 API 实例（推荐）

**配置调整**：
```javascript
// ecosystem.config.js
{
  name: 'egg-purchase-api',
  instances: 4, // 从 2 增加到 4
  exec_mode: 'cluster',
}
```

**效果**：
- 并发能力提升 **2 倍**
- 需要相应增加数据库连接池：`connection_limit=50`

**成本**：
- 内存使用增加（4 × 1GB = 4GB）
- 数据库连接数增加（4 × 20 = 80）

---

### 方案 2：增加数据库连接池

**配置调整**：
```bash
# .env
DATABASE_URL=mysql://...?connection_limit=50&pool_timeout=10
```

**效果**：
- 每个实例可处理更多并发请求
- 需要确保 MySQL `max_connections` 足够大

**MySQL 配置**：
```sql
-- 检查当前最大连接数
SHOW VARIABLES LIKE 'max_connections';

-- 增加最大连接数（需要重启 MySQL）
SET GLOBAL max_connections = 200;
```

---

### 方案 3：增加 Worker 实例

**配置调整**：
```javascript
// ecosystem.config.js
{
  name: 'egg-purchase-worker',
  instances: 2, // 从 1 增加到 2
}
```

**效果**：
- 队列处理能力提升 **2 倍**
- 评标、OCR 等任务处理更快

---

### 方案 4：添加 Redis 缓存

**实现**：
- 缓存频繁查询的数据（用户信息、门店信息等）
- 缓存报表数据（设置过期时间）

**效果**：
- 减少数据库查询压力
- 提升响应速度

---

### 方案 5：数据库读写分离

**架构**：
- 主库：处理写操作
- 从库：处理读操作

**效果**：
- 读操作并发能力大幅提升
- 写操作不受影响

**复杂度**：
- 需要配置主从复制
- 需要修改代码支持读写分离

---

## 📈 性能监控建议

### 关键指标

1. **API 响应时间**
   - 目标：P95 < 500ms
   - 监控：使用 APM 工具（如 New Relic、Datadog）

2. **数据库连接池使用率**
   - 目标：< 80%
   - 监控：Prisma 连接池指标

3. **队列长度**
   - 目标：< 100 个任务
   - 监控：BullMQ 队列长度

4. **数据库慢查询**
   - 目标：< 100ms
   - 监控：MySQL slow query log

5. **服务器资源**
   - CPU 使用率：< 70%
   - 内存使用率：< 80%
   - 磁盘 I/O：< 80%

---

## 🎯 推荐配置（高并发场景）

### 服务器配置

**最低配置**（当前）：
- CPU: 4 核
- 内存: 8GB
- 数据库连接: 40

**推荐配置**（500-1000 并发）：
- CPU: 8 核
- 内存: 16GB
- 数据库连接: 100

**高性能配置**（1000+ 并发）：
- CPU: 16 核
- 内存: 32GB
- 数据库连接: 200
- 考虑：负载均衡、读写分离、Redis 集群

---

### PM2 配置优化

```javascript
module.exports = {
  apps: [
    {
      name: 'egg-purchase-api',
      script: 'apps/api/dist/main.js',
      instances: 4, // 增加到 4
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        DATABASE_URL: 'mysql://...?connection_limit=50&pool_timeout=10',
      },
      max_memory_restart: '2G', // 增加到 2GB
    },
    {
      name: 'egg-purchase-worker',
      script: 'apps/api/dist/worker.js',
      instances: 2, // 增加到 2
      max_memory_restart: '2G',
    },
  ],
};
```

---

## 📊 总结

### 当前系统能力

- **保守估算**: **200-500 并发用户**
- **中等负载**: **500-1000 并发用户**（需要优化）
- **高负载**: **1000-2000 并发用户**（需要架构优化）

### 主要瓶颈

1. **数据库连接池**（20/实例）
2. **复杂查询性能**
3. **队列处理能力**（单 Worker）

### 优化优先级

1. **高优先级**：增加数据库连接池
2. **中优先级**：增加 API 实例数
3. **低优先级**：添加缓存、读写分离

---

**最后更新**: 2025-12-06

