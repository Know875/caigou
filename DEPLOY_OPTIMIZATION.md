# éƒ¨ç½²æ€§èƒ½ä¼˜åŒ–ä»£ç 

## ðŸ“‹ éƒ¨ç½²æ­¥éª¤

### 1. æ‹‰å–æœ€æ–°ä»£ç 

```bash
cd /root/caigou/caigou
git pull origin main
```

### 2. é‡æ–°æž„å»ºé¡¹ç›®

```bash
# æž„å»º API æœåŠ¡
cd apps/api
npm run build

# æˆ–è€…ä»Žé¡¹ç›®æ ¹ç›®å½•æž„å»ºæ‰€æœ‰æœåŠ¡
cd /root/caigou/caigou
npm run build
```

### 3. é‡å¯ PM2 æœåŠ¡

```bash
# é‡å¯ API æœåŠ¡ï¼ˆåº”ç”¨ä¼˜åŒ–åŽçš„ä»£ç ï¼‰
pm2 restart caigou-api

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤æœåŠ¡æ­£å¸¸å¯åŠ¨
pm2 logs caigou-api --lines 50
```

### 4. éªŒè¯ä¼˜åŒ–æ•ˆæžœ

```bash
# 1. æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
curl http://localhost:8081/api/health

# 2. ç›‘æŽ§ CPU ä½¿ç”¨çŽ‡ï¼ˆè¿è¡Œ 30 ç§’åŽæŒ‰ Ctrl+Cï¼‰
pm2 monit

# 3. æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
pm2 logs caigou-api --lines 100 --err
```

---

## ðŸŽ¯ é¢„æœŸæ•ˆæžœ

ä¼˜åŒ–åŽåº”è¯¥çœ‹åˆ°ï¼š
- âœ… **CPU ä½¿ç”¨çŽ‡é™ä½Ž 10-20%**
- âœ… **æŸ¥è¯¢é€Ÿåº¦æå‡ 20-30%**
- âœ… **æ—¥å¿—è¾“å‡ºå‡å°‘**ï¼ˆç”Ÿäº§çŽ¯å¢ƒä¸å†è¾“å‡º debug æ—¥å¿—ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½å½“å‰é…ç½®**ï¼ˆå¦‚æžœéœ€è¦ï¼‰ï¼š
   ```bash
   cp apps/api/.env apps/api/.env.backup
   ```

2. **å¦‚æžœæž„å»ºå¤±è´¥**ï¼š
   - æ£€æŸ¥ Node.js ç‰ˆæœ¬ï¼š`node -v`ï¼ˆåº”è¯¥æ˜¯ v18+ï¼‰
   - æ£€æŸ¥ä¾èµ–ï¼š`npm install`
   - æŸ¥çœ‹æž„å»ºé”™è¯¯ï¼š`npm run build 2>&1 | tee build.log`

3. **å¦‚æžœæœåŠ¡å¯åŠ¨å¤±è´¥**ï¼š
   - æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š`pm2 logs caigou-api --lines 200`
   - æ£€æŸ¥çŽ¯å¢ƒå˜é‡ï¼š`pm2 env 7`ï¼ˆ7 æ˜¯ caigou-api çš„è¿›ç¨‹ IDï¼‰

---

## ðŸ“Š ä¼˜åŒ–å†…å®¹

æœ¬æ¬¡ä¼˜åŒ–åŒ…æ‹¬ï¼š
1. âœ… **ç§»é™¤ä¸å¿…è¦çš„é‡å¤æŸ¥è¯¢**ï¼šåˆ é™¤äº† `findAll` æ–¹æ³•ä¸­çš„è°ƒè¯•æŸ¥è¯¢ï¼ˆç¬¬ 1162-1202 è¡Œï¼‰
2. âœ… **å‡å°‘ç”Ÿäº§çŽ¯å¢ƒæ—¥å¿—**ï¼šæ‰€æœ‰ `debug` æ—¥å¿—åªåœ¨ `development` çŽ¯å¢ƒè¾“å‡º
3. âœ… **ä¼˜åŒ–ä»£ç æ‰§è¡Œè·¯å¾„**ï¼šå‡å°‘äº†ä¸å¿…è¦çš„æ•°æ®åº“æŸ¥è¯¢å’Œæ—¥å¿—è¾“å‡º

---

## ðŸ” åŽç»­æ£€æŸ¥

éƒ¨ç½²åŽï¼Œå»ºè®®æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

```bash
# 1. æ£€æŸ¥æ…¢æŸ¥è¯¢ï¼ˆ> 2ç§’ï¼‰
mysql -u root -p -e "
SELECT 
    id,
    user,
    time,
    state,
    LEFT(info, 100) as query
FROM information_schema.processlist
WHERE time > 2 AND command != 'Sleep'
ORDER BY time DESC
LIMIT 20;
"

# 2. ç›‘æŽ§ç³»ç»Ÿè´Ÿè½½
top -b -n 1 | head -n 20

# 3. æ£€æŸ¥ API å“åº”æ—¶é—´
time curl -s http://localhost:8081/api/rfq > /dev/null
```

