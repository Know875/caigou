# 服务器字段识别问题排查指南

## 问题描述
本地能识别表头，但服务器上识别不了

## 可能的原因

### 1. 代码未更新 ⚠️ **最可能的原因**
服务器上的代码可能没有部署最新版本

**解决方案**：
```bash
# 在服务器上执行
cd /root/caigou/caigou
git pull
cd apps/api
npx prisma migrate deploy
cd /root/caigou/caigou
npm run build
pm2 restart caigou-api
pm2 restart caigou-web
```

### 2. 表头有空格或特殊字符
Excel 文件中的表头可能包含：
- 首尾空格
- 多个连续空格
- 不可见字符（如零宽空格）

**已修复**：代码现在会：
- 自动去除首尾空格
- 合并多个连续空格为一个
- 进行规范化匹配

### 3. 文件编码问题
Excel 文件可能使用了不同的编码

**检查方法**：
- 查看服务器日志中的表头列表
- 确认表头是否包含乱码

### 4. XLSX 库解析问题
`xlsx` 库在解析 Excel 时可能：
- 表头键名有变化
- 包含隐藏字符

**已修复**：添加了详细的日志记录，会输出：
- 所有表头列表
- 匹配过程
- 匹配结果

## 调试步骤

### 步骤1：检查服务器代码版本
```bash
# 在服务器上检查
cd /root/caigou/caigou
git log --oneline -5
git status
```

### 步骤2：查看服务器日志
上传文件后，查看 API 日志：
```bash
# 查看 PM2 日志
pm2 logs caigou-api --lines 100

# 或查看日志文件
tail -f /root/.pm2/logs/caigou-api-out.log
```

查找以下日志：
- `文件表头列表` - 显示所有表头
- `字段匹配成功` - 显示匹配结果
- `字段匹配失败` - 显示匹配失败的原因

### 步骤3：检查表头格式
在日志中找到 `文件表头列表`，检查：
- 表头是否有空格
- 表头是否有特殊字符
- 表头名称是否与预期一致

### 步骤4：对比本地和服务器
1. 在本地上传文件，查看日志中的表头列表
2. 在服务器上传相同文件，查看日志中的表头列表
3. 对比两者的差异

## 新增的改进

### 1. 规范化处理
- 自动去除首尾空格
- 合并多个连续空格
- 统一大小写比较

### 2. 部分匹配
如果精确匹配失败，会尝试部分匹配：
- 如果表头包含搜索名称（至少3个字符）
- 或搜索名称包含表头（至少3个字符）

### 3. 详细日志
- 记录所有表头列表
- 记录每个字段的匹配过程
- 记录匹配成功/失败的原因

## 测试建议

### 测试1：上传文件并查看日志
1. 上传包含这些表头的文件
2. 查看服务器日志中的 `文件表头列表`
3. 确认表头是否被正确识别

### 测试2：检查匹配过程
1. 查看日志中的 `字段匹配成功` 或 `字段匹配失败`
2. 确认哪些字段匹配成功，哪些失败
3. 根据日志调整表头名称

### 测试3：对比本地和服务器
1. 在本地和服务器上传相同的文件
2. 对比两者的日志输出
3. 找出差异点

## 如果仍然无法识别

### 方案1：手动检查表头
1. 在服务器日志中找到 `文件表头列表`
2. 复制实际的表头名称
3. 在代码中添加这些表头名称到 `possibleNames` 数组

### 方案2：使用部分匹配
代码现在支持部分匹配，如果表头包含搜索名称（至少3个字符），会自动匹配

### 方案3：联系支持
如果以上方法都无法解决，请提供：
- 服务器日志中的 `文件表头列表`
- 实际的 Excel 文件（如果可能）
- 本地和服务器环境的差异

