# ç½‘ç»œ I/O ç“¶é¢ˆè§£å†³æ–¹æ¡ˆ

## ğŸ“Š é—®é¢˜ç¡®è®¤

ä»è¯Šæ–­ç»“æœçœ‹ï¼š
- âœ… **æ•°æ®åº“è¿æ¥æ­£å¸¸**ï¼šæ‰€æœ‰è¿æ¥éƒ½æ˜¯ Sleep çŠ¶æ€ï¼ˆæ­£å¸¸çš„è¿æ¥æ± è¡Œä¸ºï¼‰
- âœ… **æ²¡æœ‰é•¿æ—¶é—´äº‹åŠ¡**ï¼šinnodb_trx æŸ¥è¯¢è¿”å›ç©º
- âš ï¸ **softirq å ç”¨ 135.7% CPU**ï¼šè¿™æ˜¯ç½‘ç»œä¸­æ–­å¤„ç†ï¼Œè¯´æ˜ç½‘ç»œ I/O æ˜¯ç“¶é¢ˆ
- âš ï¸ **ç³»ç»Ÿè´Ÿè½½ 8.68**ï¼šç³»ç»Ÿè¿‡è½½

**ç»“è®º**ï¼šé—®é¢˜ä¸åœ¨æ•°æ®åº“ï¼Œè€Œåœ¨**ç½‘ç»œ I/O ç“¶é¢ˆ**ã€‚

---

## ğŸ” ç«‹å³è¯Šæ–­ç½‘ç»œ I/O

### 1. æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œæµé‡

```bash
# æŸ¥çœ‹ç½‘ç»œè¿æ¥ç»Ÿè®¡
ss -s

# æŸ¥çœ‹æœ€å¤šçš„ç½‘ç»œè¿æ¥ï¼ˆæŒ‰ IPï¼‰
ss -ant | grep ESTAB | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -rn | head -n 20

# æŸ¥çœ‹ç½‘ç»œæµé‡ç»Ÿè®¡
cat /proc/net/sockstat

# æŸ¥çœ‹ç³»ç»Ÿè´Ÿè½½è¯¦æƒ…
vmstat 1 3
```

### 2. æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸è¿æ¥

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰å¤§é‡è¿æ¥æ¥è‡ªåŒä¸€ IPï¼ˆå¯èƒ½æ˜¯æ”»å‡»ï¼‰
ss -ant | grep ESTAB | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -rn | head -n 20

# æŸ¥çœ‹æ‰€æœ‰ ESTABLISHED è¿æ¥
ss -ant | grep ESTAB | wc -l
```

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šæ·»åŠ è¯·æ±‚é™æµï¼ˆæ¨èï¼‰

**ç›®çš„**ï¼šé˜²æ­¢å¤§é‡å¹¶å‘è¯·æ±‚å¯¼è‡´ç½‘ç»œ I/O ç“¶é¢ˆ

**å®ç°æ–¹æ³•**ï¼š

1. **ä½¿ç”¨ Nginx é™æµ**ï¼ˆå¦‚æœä½¿ç”¨ Nginx ä½œä¸ºåå‘ä»£ç†ï¼‰

```nginx
# åœ¨ Nginx é…ç½®ä¸­æ·»åŠ 
http {
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    
    server {
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://localhost:8081;
        }
    }
}
```

2. **ä½¿ç”¨ NestJS é™æµä¸­é—´ä»¶**

å®‰è£… `@nestjs/throttler`ï¼š
```bash
npm install @nestjs/throttler
```

åœ¨ `main.ts` ä¸­æ·»åŠ ï¼š
```typescript
import { ThrottlerModule } from '@nestjs/throttler';

@Module({
  imports: [
    ThrottlerModule.forRoot({
      ttl: 60,
      limit: 100, // æ¯åˆ†é’Ÿ 100 ä¸ªè¯·æ±‚
    }),
  ],
})
```

---

### æ–¹æ¡ˆ 2ï¼šä¼˜åŒ– API å“åº”

**ç›®çš„**ï¼šå‡å°‘ç½‘ç»œä¼ è¾“æ•°æ®é‡

**æ–¹æ³•**ï¼š
1. **å¯ç”¨å“åº”å‹ç¼©**
2. **å‡å°‘ä¸å¿…è¦çš„å“åº”æ•°æ®**
3. **ä½¿ç”¨åˆ†é¡µ**ï¼ˆé¿å…è¿”å›å¤§é‡æ•°æ®ï¼‰

**åœ¨ NestJS ä¸­å¯ç”¨å‹ç¼©**ï¼š
```typescript
// main.ts
import * as compression from 'compression';

app.use(compression());
```

---

### æ–¹æ¡ˆ 3ï¼šå‡å°‘å®ä¾‹æ•°ï¼ˆä¸´æ—¶ç¼“è§£ CPU å‹åŠ›ï¼‰

**å¦‚æœç³»ç»ŸæŒç»­è¿‡è½½ï¼Œå¯ä»¥æš‚æ—¶å‡å°‘å®ä¾‹æ•°**ï¼š

```bash
# 1. ä¿®æ”¹ ecosystem.config.js
cd /root/caigou/caigou
nano ecosystem.config.js

# å°† instances ä» 2 æ”¹ä¸º 1ï¼ˆä¸´æ—¶æµ‹è¯•ï¼‰
# caigou-api: instances: 1
# caigou-web: instances: 1

# 2. é‡æ–°åŠ è½½
pm2 reload ecosystem.config.js

# 3. è§‚å¯Ÿ CPU ä½¿ç”¨ç‡
pm2 monit
```

---

### æ–¹æ¡ˆ 4ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ DDoS æ”»å‡»

**å¦‚æœå‘ç°å¤§é‡è¿æ¥æ¥è‡ªåŒä¸€ IP**ï¼š

```bash
# æŸ¥çœ‹è¿æ¥æœ€å¤šçš„ IP
ss -ant | grep ESTAB | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -rn | head -n 10

# å¦‚æœå‘ç°å¼‚å¸¸ IPï¼Œå¯ä»¥ä½¿ç”¨ iptables å°ç¦
# iptables -A INPUT -s <å¼‚å¸¸IP> -j DROP
```

---

### æ–¹æ¡ˆ 5ï¼šä¼˜åŒ–ç½‘ç»œé…ç½®

**å¦‚æœç½‘ç»œ I/O æ˜¯ç“¶é¢ˆï¼Œå¯ä»¥ä¼˜åŒ–ç½‘ç»œé…ç½®**ï¼š

```bash
# å¢åŠ ç½‘ç»œç¼“å†²åŒºå¤§å°
sysctl -w net.core.rmem_max=16777216
sysctl -w net.core.wmem_max=16777216
sysctl -w net.ipv4.tcp_rmem="4096 87380 16777216"
sysctl -w net.ipv4.tcp_wmem="4096 65536 16777216"

# ä½¿é…ç½®æ°¸ä¹…ç”Ÿæ•ˆ
echo "net.core.rmem_max = 16777216" >> /etc/sysctl.conf
echo "net.core.wmem_max = 16777216" >> /etc/sysctl.conf
```

---

## ğŸ“‹ ç«‹å³æ‰§è¡Œçš„æ£€æŸ¥å‘½ä»¤

### 1. æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œæµé‡

```bash
# æŸ¥çœ‹ç½‘ç»œè¿æ¥ç»Ÿè®¡
ss -s

# æŸ¥çœ‹æœ€å¤šçš„ç½‘ç»œè¿æ¥ï¼ˆæŒ‰ IPï¼‰
ss -ant | grep ESTAB | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -rn | head -n 20

# æŸ¥çœ‹ç³»ç»Ÿè´Ÿè½½è¯¦æƒ…
vmstat 1 3
```

### 2. æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸è¿æ¥

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰å¤§é‡è¿æ¥æ¥è‡ªåŒä¸€ IP
ss -ant | grep ESTAB | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -rn | head -n 20
```

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

- **æ·»åŠ è¯·æ±‚é™æµ**ï¼šå‡å°‘ç½‘ç»œ I/O å‹åŠ›ï¼ŒCPU ä½¿ç”¨ç‡é™ä½ 30-50%
- **ä¼˜åŒ– API å“åº”**ï¼šå‡å°‘ç½‘ç»œä¼ è¾“ï¼Œæå‡å“åº”é€Ÿåº¦
- **å‡å°‘å®ä¾‹æ•°**ï¼šCPU ä½¿ç”¨ç‡é™ä½ 40-60%

---

## âš ï¸ é‡è¦æç¤º

1. **å…ˆè¯Šæ–­ï¼Œå†ä¼˜åŒ–**ï¼šå…ˆæ‰§è¡Œæ£€æŸ¥å‘½ä»¤ï¼Œç¡®è®¤æ˜¯å¦æœ‰å¼‚å¸¸è¿æ¥
2. **ç›‘æ§å˜åŒ–**ï¼šæ¯æ¬¡ä¼˜åŒ–åè§‚å¯Ÿ 5-10 åˆ†é’Ÿ
3. **å¤‡ä»½é…ç½®**ï¼šä¿®æ”¹å‰å¤‡ä»½é…ç½®æ–‡ä»¶

