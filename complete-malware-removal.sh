#!/bin/bash

echo "=========================================="
echo "å½»åº•æ¸…é™¤æ¶æ„è½¯ä»¶ï¼ˆæ¸…ç†æ‰€æœ‰æ¢å¤æœºåˆ¶ï¼‰"
echo "=========================================="
echo ""

# 1. ç»ˆæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
echo "ðŸ“Š 1. ç»ˆæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹"
echo "----------------------------------------"
pkill -9 -f "runnv" 2>/dev/null || true
pkill -9 -f "alive" 2>/dev/null || true
pkill -9 -f "lived" 2>/dev/null || true
pkill -9 -f "rondo" 2>/dev/null || true
pkill -9 -f "fghgf" 2>/dev/null || true
pkill -9 -f "monitor_tomcat" 2>/dev/null || true
pkill -9 node 2>/dev/null || true
pkill -9 pm2 2>/dev/null || true
sleep 3
echo "âœ“ è¿›ç¨‹å·²ç»ˆæ­¢"

# 2. æ¸…ç† crontabï¼ˆæœ€å…³é”®ï¼ï¼‰
echo ""
echo "ðŸ“Š 2. æ¸…ç† crontabï¼ˆæœ€å…³é”®ï¼ï¼‰"
echo "----------------------------------------"

# æ¸…ç† root crontab
echo "æ¸…ç† root crontab..."
crontab -l 2>/dev/null | grep -v "rondo\|re.sh\|unk.sh\|corn\|fghgf\|runnv\|alive\|lived" | crontab - 2>/dev/null || crontab -r 2>/dev/null || true

# æ¸…ç† /etc/crontab
echo "æ¸…ç† /etc/crontab..."
sed -i '/rondo\|re.sh\|unk.sh\|corn\|fghgf\|runnv\|alive\|lived/d' /etc/crontab 2>/dev/null || true

# åˆ é™¤ /etc/cron.d/rondo
echo "åˆ é™¤ /etc/cron.d/rondo..."
rm -f /etc/cron.d/rondo 2>/dev/null || true

# éªŒè¯
echo "éªŒè¯ crontab..."
crontab -l 2>/dev/null | grep -E "rondo|re.sh|unk.sh|corn|fghgf|runnv|alive|lived" && echo "âš ï¸  ä»æœ‰æ¶æ„ crontab ä»»åŠ¡" || echo "âœ“ crontab å·²æ¸…ç†"

echo "éªŒè¯ /etc/crontab..."
grep -E "rondo|re.sh|unk.sh|corn|fghgf|runnv|alive|lived" /etc/crontab 2>/dev/null && echo "âš ï¸  ä»æœ‰æ¶æ„ç³»ç»Ÿ crontab" || echo "âœ“ /etc/crontab å·²æ¸…ç†"

# 3. ç¦ç”¨å¹¶åˆ é™¤ systemd æœåŠ¡
echo ""
echo "ðŸ“Š 3. ç¦ç”¨å¹¶åˆ é™¤ systemd æœåŠ¡"
echo "----------------------------------------"
systemctl stop alive.service 2>/dev/null || true
systemctl stop lived.service 2>/dev/null || true
systemctl stop nginxd.service 2>/dev/null || true
systemctl disable alive.service 2>/dev/null || true
systemctl disable lived.service 2>/dev/null || true
systemctl disable nginxd.service 2>/dev/null || true

# åˆ é™¤æœåŠ¡æ–‡ä»¶
rm -f /etc/systemd/system/alive.service 2>/dev/null || true
rm -f /etc/systemd/system/lived.service 2>/dev/null || true
rm -f /etc/systemd/system/nginxd.service 2>/dev/null || true
rm -f /etc/systemd/system/multi-user.target.wants/alive.service 2>/dev/null || true
rm -f /etc/systemd/system/multi-user.target.wants/lived.service 2>/dev/null || true

# é‡ç½®å¤±è´¥çš„æœåŠ¡çŠ¶æ€
systemctl reset-failed alive.service 2>/dev/null || true
systemctl reset-failed lived.service 2>/dev/null || true
systemctl reset-failed nginxd.service 2>/dev/null || true

systemctl daemon-reload 2>/dev/null || true
echo "âœ“ systemd æœåŠ¡å·²æ¸…ç†"

# 4. åˆ é™¤æ‰€æœ‰æ¶æ„æ–‡ä»¶å’Œç›®å½•
echo ""
echo "ðŸ“Š 4. åˆ é™¤æ¶æ„æ–‡ä»¶å’Œç›®å½•"
echo "----------------------------------------"
rm -rf /tmp/runnv 2>/dev/null || true
rm -rf /etc/rondo 2>/dev/null || true
rm -f /tmp/fghgf 2>/dev/null || true
rm -f /tmp/config.json 2>/dev/null || true
rm -f /dev/health.sh 2>/dev/null || true

# åˆ›å»ºå¹¶é”å®šæ–‡ä»¶ï¼ˆé˜²æ­¢é‡æ–°åˆ›å»ºï¼‰
mkdir -p /tmp/runnv 2>/dev/null || true
touch /tmp/runnv/alive.sh /tmp/runnv/lived.sh 2>/dev/null || true
touch /tmp/fghgf /tmp/config.json /dev/health.sh 2>/dev/null || true
chmod 000 /tmp/runnv/alive.sh /tmp/runnv/lived.sh /tmp/fghgf /tmp/config.json /dev/health.sh 2>/dev/null || true
chattr +i /tmp/runnv/alive.sh /tmp/runnv/lived.sh /tmp/fghgf /tmp/config.json /dev/health.sh 2>/dev/null || true
chattr +i /tmp/runnv 2>/dev/null || true

# é”å®š /etc/rondo ç›®å½•ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
if [ -d /etc/rondo ]; then
    chmod 000 /etc/rondo 2>/dev/null || true
    chattr +i /etc/rondo 2>/dev/null || true
fi

echo "âœ“ æ–‡ä»¶å·²åˆ é™¤å¹¶é”å®š"

# 5. é˜»æ­¢æ¶æ„ IPï¼ˆä½¿ç”¨ iptables æˆ– ufwï¼‰
echo ""
echo "ðŸ“Š 5. é˜»æ­¢æ¶æ„ IP"
echo "----------------------------------------"

# å°è¯•ä½¿ç”¨ ufw
if command -v ufw >/dev/null 2>&1; then
    ufw deny from 80.64.16.241 2>/dev/null || true
    ufw deny to 80.64.16.241 2>/dev/null || true
    echo "âœ“ å·²ä½¿ç”¨ ufw é˜»æ­¢æ¶æ„ IP"
elif command -v /usr/sbin/ufw >/dev/null 2>&1; then
    /usr/sbin/ufw deny from 80.64.16.241 2>/dev/null || true
    /usr/sbin/ufw deny to 80.64.16.241 2>/dev/null || true
    echo "âœ“ å·²ä½¿ç”¨ ufw é˜»æ­¢æ¶æ„ IP"
# å°è¯•ä½¿ç”¨ iptables
elif command -v iptables >/dev/null 2>&1; then
    iptables -A INPUT -s 80.64.16.241 -j DROP 2>/dev/null || true
    iptables -A OUTPUT -d 80.64.16.241 -j DROP 2>/dev/null || true
    echo "âœ“ å·²ä½¿ç”¨ iptables é˜»æ­¢æ¶æ„ IP"
else
    echo "âš ï¸  æ— æ³•æ‰¾åˆ°é˜²ç«å¢™å·¥å…·ï¼Œè¯·æ‰‹åŠ¨é˜»æ­¢ IP: 80.64.16.241"
fi

# 6. å†æ¬¡ç»ˆæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
echo ""
echo "ðŸ“Š 6. å†æ¬¡ç»ˆæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹"
echo "----------------------------------------"
pkill -9 -f "runnv" 2>/dev/null || true
pkill -9 -f "alive" 2>/dev/null || true
pkill -9 -f "lived" 2>/dev/null || true
pkill -9 -f "rondo" 2>/dev/null || true
sleep 2
echo "âœ“ è¿›ç¨‹å·²å†æ¬¡ç»ˆæ­¢"

# 7. éªŒè¯æ¸…ç†ç»“æžœ
echo ""
echo "ðŸ“Š 7. éªŒè¯æ¸…ç†ç»“æžœ"
echo "----------------------------------------"
echo "æ£€æŸ¥è¿›ç¨‹..."
if ps aux | grep -E "runnv|alive|lived|rondo|fghgf|monitor_tomcat" | grep -v grep; then
    echo "âš ï¸  ä»æœ‰å¯ç–‘è¿›ç¨‹"
else
    echo "âœ“ æ— å¯ç–‘è¿›ç¨‹"
fi

echo ""
echo "æ£€æŸ¥ crontab..."
if crontab -l 2>/dev/null | grep -E "rondo|re.sh|unk.sh|corn|fghgf|runnv|alive|lived"; then
    echo "âš ï¸  crontab ä¸­ä»æœ‰æ¶æ„ä»»åŠ¡"
else
    echo "âœ“ crontab å·²æ¸…ç†"
fi

echo ""
echo "æ£€æŸ¥ systemd æœåŠ¡..."
if systemctl list-units --type=service --all | grep -E "alive|lived|nginxd" | grep -v "lvm2-monitor"; then
    echo "âš ï¸  ä»æœ‰å¯ç–‘æœåŠ¡"
else
    echo "âœ“ systemd æœåŠ¡å·²æ¸…ç†"
fi

# 8. ç­‰å¾…ç³»ç»Ÿç¨³å®š
echo ""
echo "ðŸ“Š 8. ç­‰å¾…ç³»ç»Ÿç¨³å®šï¼ˆ30ç§’ï¼‰..."
sleep 30

# 9. æœ€ç»ˆæ£€æŸ¥
echo ""
echo "ðŸ“Š 9. æœ€ç»ˆæ£€æŸ¥"
echo "----------------------------------------"
if ps aux | grep -E "runnv|alive|lived|rondo|fghgf|monitor_tomcat" | grep -v grep; then
    echo "âš ï¸  æ¶æ„è¿›ç¨‹å·²æ¢å¤ï¼"
    echo ""
    echo "è¯·æ£€æŸ¥ï¼š"
    echo "1. crontab -l"
    echo "2. cat /etc/crontab"
    echo "3. ls -la /etc/cron.d/"
    echo "4. systemctl list-units --type=service --all"
else
    echo "âœ“ æ¸…ç†æˆåŠŸï¼Œæ— æ¶æ„è¿›ç¨‹"
fi

# 10. å¯åŠ¨æœåŠ¡
echo ""
echo "ðŸ“Š 10. å¯åŠ¨æœåŠ¡"
echo "----------------------------------------"
cd /root/caigou/caigou

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs

# å¯åŠ¨ API
echo "å¯åŠ¨ API æœåŠ¡..."
NODE_OPTIONS="--max-old-space-size=128" \
NODE_ENV=production \
nohup node apps/api/dist/main.js > logs/api-out.log 2> logs/api-error.log &
API_PID=$!
echo "API PID: $API_PID"
sleep 10

# æ£€æŸ¥ API æ˜¯å¦å¯åŠ¨æˆåŠŸ
if ps -p $API_PID > /dev/null; then
    echo "âœ“ API æœåŠ¡å¯åŠ¨æˆåŠŸ (PID: $API_PID)"
    sleep 5
    curl -s http://localhost:8081/api/health && echo "" || echo "âš ï¸  API å°šæœªå°±ç»ª"
    
    # å¯åŠ¨ Worker
    echo ""
    echo "å¯åŠ¨ Worker æœåŠ¡..."
    NODE_OPTIONS="--max-old-space-size=128" \
    NODE_ENV=production \
    nohup node apps/api/dist/worker.js > logs/worker-out.log 2> logs/worker-error.log &
    WORKER_PID=$!
    echo "Worker PID: $WORKER_PID"
    sleep 10
    
    if ps -p $WORKER_PID > /dev/null; then
        echo "âœ“ Worker æœåŠ¡å¯åŠ¨æˆåŠŸ (PID: $WORKER_PID)"
    else
        echo "âœ— Worker æœåŠ¡å¯åŠ¨å¤±è´¥"
        tail -n 20 logs/worker-error.log
    fi
else
    echo "âœ— API æœåŠ¡å¯åŠ¨å¤±è´¥"
    tail -n 30 logs/api-error.log
fi

# ä¿å­˜è¿›ç¨‹ä¿¡æ¯
cat > /root/caigou/caigou/.service-pids << EOF
API_PID=$API_PID
WORKER_PID=$WORKER_PID
EOF

echo ""
echo "=========================================="
echo "æ¸…ç†å’Œå¯åŠ¨å®Œæˆ"
echo "=========================================="
echo ""
echo "ðŸ“‹ é‡è¦æç¤ºï¼š"
echo "1. æ¶æ„è½¯ä»¶æ¯åˆ†é’Ÿä¼šå°è¯•ä»Ž http://80.64.16.241/re.sh ä¸‹è½½å¹¶æ‰§è¡Œ"
echo "2. å·²æ¸…ç†æ‰€æœ‰ crontab å’Œ systemd æœåŠ¡"
echo "3. å·²é˜»æ­¢æ¶æ„ IPï¼ˆå¦‚æžœé˜²ç«å¢™å¯ç”¨ï¼‰"
echo "4. è¯·å®šæœŸæ£€æŸ¥ crontab å’Œè¿›ç¨‹ï¼Œç¡®ä¿æ¶æ„è½¯ä»¶ä¸ä¼šæ¢å¤"
echo ""
echo "ðŸ“‹ ç›‘æŽ§å‘½ä»¤ï¼š"
echo "  crontab -l                    # æ£€æŸ¥ crontab"
echo "  ps aux | grep -E 'runnv|alive|lived'  # æ£€æŸ¥è¿›ç¨‹"
echo "  systemctl list-units --type=service | grep -E 'alive|lived'  # æ£€æŸ¥æœåŠ¡"

