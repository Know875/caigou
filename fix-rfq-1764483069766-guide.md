# 修复 RFQ-1764483069766 中 UR神光棒 的中标问题

## 问题描述

在 RFQ-1764483069766 中：
- **按商品选商**显示：UR神光棒 → 赛罗 ¥549.00（正确）
- **中标订单物流信息**显示：UR神光棒 → 豪 ¥550.00（错误）

## 问题原因

可能的原因：
1. 数据库中豪的 Award 记录中的 `quoteId` 指向了豪的整单报价
2. 豪的整单报价包含了 UR神光棒的 `quoteItem`（550元）
3. 但 UR神光棒实际上应该由赛罗中标（549元，且先提交）

## 修复步骤

### 1. 执行查询脚本

首先执行 `check-rfq-1764483069766.sql`，查看实际数据情况：

```bash
mysql -u your_username -p your_database_name < check-rfq-1764483069766.sql
```

### 2. 分析数据

根据查询结果，确认：
- UR神光棒的 `rfqItem.itemStatus` 是否为 `AWARDED`
- 是否有 Award 记录指向赛罗的 quote（包含 UR神光棒）
- 是否有 Award 记录指向豪的 quote（包含 UR神光棒）

### 3. 执行修复脚本

根据实际数据情况，执行 `fix-rfq-1764483069766-ur-shenguangbang.sql`：

```bash
mysql -u your_username -p your_database_name < fix-rfq-1764483069766-ur-shenguangbang.sql
```

### 4. 修复逻辑

根据查询结果，可能需要：

#### 情况1：赛罗没有 Award 记录
- 创建赛罗的 Award 记录
- 确保 Award 记录的 `quoteId` 指向赛罗的 quote（包含 UR神光棒）
- 计算 `finalPrice`（包含 SHF歌查德 218元 + UR神光棒 549元 = 767元）

#### 情况2：豪的 Award 记录包含了 UR神光棒
- 更新豪的 Award 记录的 `finalPrice`（减去 UR神光棒的 550元）
- 更新赛罗的 Award 记录的 `finalPrice`（加上 UR神光棒的 549元）
- 或者：删除豪的 Award 记录，重新创建（只包含 MG艾比安 188元）

#### 情况3：Award 记录的 `quoteId` 指向错误
- 更新 Award 记录的 `quoteId`，确保指向正确的 quote
- 重新计算 `finalPrice`

## 验证修复

修复后，执行以下查询验证：

```sql
-- 查看修复后的 Award 记录
SELECT 
  a.id as award_id,
  u.username as supplier_name,
  a.finalPrice,
  GROUP_CONCAT(ri.productName SEPARATOR ', ') as products
FROM awards a
INNER JOIN users u ON a.supplierId = u.id
INNER JOIN quotes q ON a.quoteId = q.id
INNER JOIN quote_items qi ON q.id = qi.quoteId
INNER JOIN rfq_items ri ON qi.rfqItemId = ri.id
INNER JOIN rfqs r ON ri.rfqId = r.id
WHERE r.rfqNo = 'RFQ-1764483069766'
GROUP BY a.id, u.username, a.finalPrice
ORDER BY a.createdAt;
```

预期结果：
- 豪：finalPrice = 188元（只有 MG艾比安）
- 赛罗：finalPrice = 767元（SHF歌查德 218元 + UR神光棒 549元）

## 注意事项

1. ⚠️ **备份数据库**：在执行修复前，务必备份数据库
2. ⚠️ **测试环境**：建议先在测试环境执行，验证修复逻辑
3. ⚠️ **事务处理**：建议使用事务，确保数据一致性
4. ⚠️ **代码修复**：修复数据库后，代码逻辑应该能正确显示

## 相关文件

- `check-rfq-1764483069766.sql` - 查询脚本
- `fix-rfq-1764483069766-ur-shenguangbang.sql` - 修复脚本（需要根据实际数据调整）

